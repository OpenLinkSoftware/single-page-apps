<!DOCTYPE html>
<html lang="en">
	<head>
		<title> Downloads Form </title>
		<!-- Latest compiled and minified CSS -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
		<!-- jQuery library -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
		<!-- Latest compiled JavaScript -->
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
		<!-- Authentication and RDF procssing library -->
		<script src="./common/js/solid-auth-client.bundle.js"></script> 
	    <!-- <script src="https://cdn.jsdelivr.net/npm/solid-auth-client@2.3.0/dist-lib/solid-auth-client.bundle.js"></script> -->
		<!-- <script src="./common/js/rdflib.min.js"></script> -->
		<script src="https://cdn.jsdelivr.net/npm/rdflib@0.20.1/dist/rdflib.min.js"></script>
                <!-- Structured data island describing the app -->
		<script id="dataIslandID" type="application/ld+json"></script>
	</head>

	<body onload="onLoad()">
	<!-- Button feedback spinner -->
	<div id="spinner"></div>
	<!-- Start of tabs container -->
	<div class="container">
	  <!-- Create tabs menu -->
	  <ul class="nav nav-tabs">
		<!-- Start Options Dropdown -->
		<li class="pull-right" class="dropdown">
		    <a class="dropdown-toggle" style="max-height: 10px" data-toggle="dropdown" href="#"> 
			<span class="glyphicon glyphicon-cog"></span>
		    <span class="caret"></span></a>
			
		    <ul class="dropdown-menu">
			  <!-- Place holder -->
			  <div class="checkbox">
			    <label><input id="placeholderID" type="checkbox" value="">Placeholder</label>
			  </div>
                          <!-- Console Print Commands Checkbox  -->
                          <div class="checkbox">
                            <label><input id="cmdID" type="checkbox" value="">Console Log Commands</label>
                          </div>
		    </ul>
		  </li>
		  <!-- End Dropdown -->
		  <a id="logged-href" href="" title="" style="margin-top: 5px; margin-left: 15px;" class="pull-right" class="hidden"><img id="uid-icon" src="./common/uid.png"></a>
		  <li class="pull-right"> <button id="loginID" style="margin-top: 5px" type="button" onclick="authLogin(true)" class="hidden btn btn-primary">Login</button> </li>
		  <li class="pull-right"><button id="logoutID" style="margin-top: 5px" type="button" onclick="authLogout()" class="hidden btn btn-danger">Logout</button></li>
		  <li class="pull-right"><a id="permalinkID">Permalink</a></li>
		  
	  </ul>
	  <!-- End of tabs menu -->
  
	  <div class="container">
		  				<h1 style="text-align:center">Installer Download Wizard &#45; ODBC, JDBC, ADO.NET, OLE DB Drivers / Connectors</h1>
                                                <span id="messageSpanID"></span>
		  				<form id="downloadFormID" class="form" method="post">
		  					<div class="form-group">
		  	    <div class="row">
		  	        <div class="col-xs-6">

                                                                <label for="applicationNameID">Application Name </label>
                                                                <span class="glyphicon glyphicon-question-sign" data-toggle="tooltip" data-original-title="Select the data consuming application."></span>
                                                                <select id="applicationNameID" class="form-control" name="applicationName" onchange="appNameSelected(this)">
                                                                <option value="selectMessage" selected> -- select an application -- </option>
                                                                </select>
		  						<p class="errorMessage" id="applicationNameErrorID" ></p>
                                                                <label for="applicationVersion">Full Version (if known)</label>
                                                                <br />
		  						<input size="20" id="applicationVersionID" name="applicationVersion" onchange="applicationVersionChanged(this)"></input>
		  	        </div>
		  	        <div class="col-xs-6">
	                                                        <label for="appHostOsFamID">Application Host OS Family</label>
                                                                <span class="glyphicon glyphicon-question-sign" data-toggle="tooltip" data-original-title="Select an operating system family."></span>
                                                                <select id="appHostOsFamID" class="form-control" name="appHostOsFam" onchange="appHostOsFamSelected(this)" >
                                                                <option value="selectMessage" disabled selected> -- select operating system family -- </option>
                                                                </select>
		  						<p class="errorMessage" id="appHostOsFamErrorID" ></p>

	                                                        <label for="appHostOsID">Application Host OS</label>
                                                                <span class="glyphicon glyphicon-question-sign" data-toggle="tooltip" data-original-title="Select an operating system."></span>
                                                                <select id="appHostOsID" class="form-control" disabled name="appHostOs" onchange="appHostOsSelected(this)" >
                                                                <option value="selectMessage" disabled selected> -- select operating system -- </option>
                                                                </select>
		  						<p class="errorMessage" id="appHostOsErrorID" ></p>
                                                                <label for="appHostOsVersion">Full Version (if known)</label>
                                                                <br />
		  						<input size="20" id="appHostOsVersionID" name="appHostOsVersion" onchange="appHostOsVersionChanged(this)"></input>
		  	        </div>
		  	    </div>
                                <hr>
		  	    <div class="row">
		  	        <div class="col-xs-6">
                                                                <label for="databaseServerFamID">Database Server Type </label>
                                                                <span class="glyphicon glyphicon-question-sign" data-toggle="tooltip" data-original-title="Select the database server type."></span>
                                                                <select id="databaseServerFamID" class="form-control" name="databaseServerFam" onchange="databaseServerFamSelected(this)" >
                                                                <option value="selectMessage" disabled selected> -- select the database server type -- </option>
                                                                </select>
		  						<p class="errorMessage" id="databaseServerFamErrorID" ></p>

                                                                <label for="databaseServerID">Database Server </label>
                                                                <span class="glyphicon glyphicon-question-sign" data-toggle="tooltip" data-original-title="Select the database server."></span>
                                                                <select id="databaseServerID" class="form-control" name="databaseServer" onchange="databaseServerSelected(this)" >
                                                                <option value="selectMessage" disabled selected> -- select the database server -- </option>
                                                                </select>
		  						<p class="errorMessage" id="databaseServerErrorID" ></p>
                                                                <label for="dbmsVersion">Full Version (if known)</label>
                                                                <br />
		  						<input size="20" id="dbmsVersionID" name="dbmsVersion" onchange="dbmsVersionChanged(this)"></input>
		  	        </div>
		  	        <div class="col-xs-6">
	                                                        <label for="dbmsHostOsFamID">Database Server Host OS Family</label>
                                                                <span class="glyphicon glyphicon-question-sign" data-toggle="tooltip" data-original-title="Select an operating system family."></span>
                                                                <select id="dbmsHostOsFamID" class="form-control" name="dbmsHostOsFam" onchange="dbmsHostOsFamSelected(this)" >
                                                                <option value="selectMessage" disabled selected> -- select operating system family -- </option>
                                                                </select>
		  						<p class="errorMessage" id="dbmsHostOsFamErrorID" ></p>

	                                                        <label for="dbmsHostOsID">Database Server Host OS</label>
                                                                <span class="glyphicon glyphicon-question-sign" data-toggle="tooltip" data-original-title="Select an operating system."></span>
                                                                <select id="dbmsHostOsID" class="form-control" disabled name="dbmsHostOs" onchange="dbmsHostOsSelected(this)" >
                                                                <option value="selectMessage" disabled selected> -- select operating system -- </option>
                                                                </select>
		  						<p class="errorMessage" id="dbmsHostOsErrorID" ></p>
                                                                <label for="dbmsHostOsVersion">Full Version (if known)</label>
                                                                <br />
		  						<input size="20" id="dbmsHostOsVersionID" name="dbmsHostOsVersion" onchange="dbmsHostOsVersionChanged(this)"></input>
		  	        </div>
		  	    </div>
                                <hr>
		  					<!-- Start Buttons -->
		  					<div class=button-wrapper>
		  					<span>
							<button id="clearBtnID" type="button" onclick="clearInput()" class="btn btn-primary">Clear</button>
		  					<button id="downloadBtnID" type="button" onclick="findDownloads()" class="btn btn-success" disabled>Find downloads</button>
							</span>
		  					</div>
		  					<!-- End Buttons -->
		  				</form>
		  				<!-- End of Form Div -->
				
		  	    </div>
                            <div>
                            <span id="resultAreaMultitierID"> 
		  	        <p class="errorMessage" id="resultAreaMultitierErrorID" ></p>
                            </span>
                            <span id="resultAreaLiteID"> </span>
		  	        <p class="errorMessage" id="resultAreaLiteErrorID" ></p>
                            </span>
		  	    </div>

			    <div class="modal" tabindex="-1" role="dialog" id="modalID">
                              <div class="modal-dialog" role="document">
                                <div class="modal-content">
			          <div class="modal-header">
                                    <h5 class="modal-title">Change Upload Location</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
			              <span aria-hidden="true">&times;</span>
                                    </button>
			          </div>
                                  <div class="modal-body">
			            <p>
                                      <label for="uploadLocationID">Upload Location: </label>
                                      <input type="text" id="uploadLocationID" name="uploadLocation" value=saveLocation size="80">
			            </p>
                                  </div>
                                  <div class="modal-footer">
			            <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="saveUploadLocation()" >Save changes</button>
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
			          </div>
                                </div>
			      </div>
                            </div>
		
	  </div>
	</div>
	
	<!-- Error Display CSS -->
	<style>
		/* sets input field red if invalid */
		.error {
		  border:2px solid red;
		}
	
		/* sets error message color red */
		.errorMessage {
			color:red;
		}
	
		/* wraps text in table */
		td {
		  word-wrap: break-word;
		}
	</style>
	
	<!-- Spinner CSS -->
	<style>
		#spinner{
		    position:fixed;
		    width:100%;
		    left:0;right:0;top:0;bottom:0;
		    background-color: rgba(255,255,255,0.7);
		    z-index:9999;
		    display:none;
		}

		@keyframes spin {
		  from {
		      transform: rotate(0deg);
		  } to {
		      transform: rotate(360deg);
		  }
		}
		
		#spinner::after {
		    content:'';
		    display:block;
		    position:absolute;
		    left:48%;top:40%;
		    width:40px;height:40px;
		    border-style:solid;
		    border-color:black;
		    border-top-color:transparent;
		    border-width: 4px;
		    border-radius:50%;
		    -webkit-animation: spin .8s linear infinite;
		    animation: spin .8s linear infinite;
		}
	</style>
	
	<!-- Dropdown menu CSS-->
	<style>
		.dropdown-menu {
		   padding-left: 15px;
		}
		.glyphicon.glyphicon-cog {
		    font-size: 20px;
		}
	</style>
	
	<!-- Spinner Javascript -->
	<script>
		function showSpinner() {
		  document.getElementById("spinner").className = "show";
		}
		
		function hideSpinner() {
		  document.getElementById("spinner").className = document.getElementById("spinner").className.replace("show", "");
		}
	</script>

	<!-- These Functions Modify the Onscreen Display -->
	<script>
                var solid_storage = null; 

		//Tooltip activation function
		$(document).ready(function(){
		    $('[data-toggle="tooltip"]').tooltip({
		        placement : 'right'
		    }); 

		  const loginButton = document.getElementById('loginID');
		  const logoutButton = document.getElementById('logoutID');

		  solid.auth.trackSession(async (session) => {
	              const loggedHref = document.getElementById('logged-href')
	              const loggedIn = !!session
	              loginButton.classList.toggle('hidden', loggedIn)
	              logoutButton.classList.toggle('hidden', !loggedIn)
	              if (loggedIn) {
	                if (session.webId) {
	                  loggedHref.classList.remove('hidden')
	                  loggedHref.href = session.webId
	                  loggedHref.title = session.webId

	                  solid_storage = await fetchProfile(session.webId);
	                  sessionStorage.setItem('solid_storage', solid_storage);
	                }

	              } else {
	                loggedHref.classList.add('hidden')
	                loggedHref.href = ''
	                loggedHref.title = ''
	                solid_storage = null;
	                sessionStorage.removeItem('solid_storage');
	              }
	            })
		});
		
	</script>

	<!-- These Functions are Used to Display Validation Errors -->
	<script>
		// Function is used to remove input field border color
		function setInputColor(id) {
			document.getElementById(id).className = document.getElementById(id).className + " error";  // this adds the error class
		}
	
		// Function is used to remove input field border color
		function removeInputColor(id) {
			document.getElementById(id).className = "form-control"; // removes error class
		}
	
		// Function is used to display error message
		function errorMessage(id, error) {
			document.getElementById(id).innerHTML = error ; 
		}

		// Function is used to clear error message
		function errorMessageClear(id) {
			document.getElementById(id).innerHTML = "" ; 
		}

		// Function is used to clear all error messages
		function errorMessagesClearAll() {
                  var errorMessages = document.getElementsByClassName("errorMessage");
                  for (var i=0; i < errorMessages.length; i++)
                        errorMessages[i].innerHTML = "" ;
		}
	</script>

	<!-- These Functions Handle the Form Validation -->
	<script>

	</script>
	
	<!-- These Functions Handle the Functionality of the Page -->
	<script>

                var installerArray = [];
                //var endpoint = "https://www.openlinksw.com/sparql?default-graph-uri=&query=" ;
                //var endpoint = "https://localhost/sparql?default-graph-uri=&query=" ;
                var endpoint = "https://www.openlinksw.com/sparql?default-graph-uri=&query=" ;
                var graph = "urn:openlink:download:search:record" ;
                var saveLocation = "";

                var initialApplicationName = "";
                var initialDatabaseServerFam = "";
                var initialDatabaseServer = "";
                var initialAppHostOsFam = "";
                var initialAppHostOs = "";
                var initialDbmsHostOsFam = "";
                var initialDbmsHostOs = "";
                var initialSaveLocation = "";

                function onLoad() {

                  document.getElementById("dataIslandID").text = JSON.stringify(getInitialJsonMetadata()); 

                  // check for params - if so set the dropdowns and get the downloads
                  var queryString = window.location.search;
                  var params = new URLSearchParams(queryString);
                  var getResults = params.get("getResults");

                  if (getResults == "true") {
                       initialApplicationName = decodeURIComponent(params.get("applicationName"));
                       initialDatabaseServerFam = decodeURIComponent(params.get("databaseServerFam"));
                       initialDatabaseServer = decodeURIComponent(params.get("databaseServer"));
                       initialAppHostOsFam = decodeURIComponent(params.get("appHostOsFam"));
                       initialAppHostOs = decodeURIComponent(params.get("appHostOs"));
                       initialDbmsHostOsFam = decodeURIComponent(params.get("dbmsHostOsFam"));
                       initialDbmsHostOs = decodeURIComponent(params.get("dbmsHostOs"));
                       initialSaveLocation = decodeURIComponent(params.get("saveLocation"));
                       handlePermalink();
                  } else {
                    clearInput()
                  }
                }

                // build the data island
                function getInitialJsonMetadata () {
                    return {
                      "@context": {
                        "schema": "http://schema.org/",
                        "xsd": "http://www.w3.org/2001/XMLSchema#"
                      },
                      "@graph": [
                        {
                          "@type": "schema:WebPage",
                          "@id": window.location.origin + window.location.pathname,
                          "schema:description": "Single page application that allows searching for installers suitable for a specified environment.",
                          "schema:name": "OpenLink Downloads Search",
                          "schema:publisher": "http://www.openlinksw.com/#this" ,
                          "schema:relatedLink": [
                            "https://www.openlinksw.com" ,
                            "https://virtuoso.openlinksw.com" ,
                            "https://uda.openlinksw.com" ,
                            "http://osds.openlinksw.com" ,
                            "http://ods.openlinksw.com" ,
                            "http://ode.openlinksw.com" ,
                            "http://osdb.openlinksw.com" ,
                            "http://osde.openlinksw.com" ,
                            "http://youid.openlinksw.com" 
                          ]
                        }
                      ]
                    };
                }

                function getSchemaAboutRelations () {
                    let myJson = JSON.parse(document.getElementById("dataIslandID").text);

                    myJson["@graph"][0]["schema:about"] = installerArray;
                    return myJson;
                }

                function clearInput(){
                  document.getElementById("dataIslandID").text = JSON.stringify(getInitialJsonMetadata()); 
                  document.getElementById("messageSpanID").textContent = "";
                  resultAreaReset();
                  applicationNameSelectorReset();
                  appHostOsFamSelectorReset();
                  appHostOsSelectorReset();
                  databaseServerFamSelectorReset();
                  databaseServerSelectorReset();
                  dbmsHostOsFamSelectorReset();
                  dbmsHostOsSelectorReset();
                  applicationVersionReset();
                  appHostOsVersionReset();
                  dbmsVersionReset();
                  dbmsHostOsVersionReset();
                  populateApplicationNameSelector();
                  populateAppHostOsFamSelector();
                  populateDatabaseServerSelector();
                  populateDbmsHostOsFamSelector();
                  checkAllSelected();
                }

                function applicationVersionReset () {
                  var applicationVersion = document.getElementById("applicationVersionID");
                  applicationVersion.value = "";
                }

                function appHostOsVersionReset () {
                  var appHostOsVersion = document.getElementById("appHostOsVersionID");
                  appHostOsVersion.value = "";
                }

                function dbmsVersionReset () {
                  var dbmsVersion = document.getElementById("dbmsVersionID");
                  dbmsVersion.value = "";
                }

                function dbmsHostOsVersionReset () {
                  var dbmsHostOsVersion = document.getElementById("dbmsHostOsVersionID");
                  dbmsHostOsVersion.value = "";
                }

                function resultAreaReset() {
                  var resultAreaMultitier = document.getElementById("resultAreaMultitierID");
                  var resultAreaLite = document.getElementById("resultAreaLiteID");
                  var child = resultAreaMultitier.lastElementChild;  
                  while (child) { 
                    resultAreaMultitier.removeChild(child); 
                    child = resultAreaMultitier.lastElementChild; 
                  } 
                  child = resultAreaLite.lastElementChild;  
                  while (child) { 
                    resultAreaLite.removeChild(child); 
                    child = resultAreaLite.lastElementChild; 
                  } 
                }

                function applicationNameSelectorReset() {
                    var applicationName = document.getElementById("applicationNameID");
 
                    applicationName.innerHTML = '';
                    var selectOption = document.createElement('option');
                    selectOption.value = 'selectMessage';
                    selectOption.innerHTML = ' -- select an application -- ';
                    selectOption.disabled = true;
                    selectOption.selected = true;
                    applicationName.appendChild(selectOption);
                }
  
                function appHostOsFamSelectorReset() {
                    var appHostOsFam = document.getElementById("appHostOsFamID");

                    appHostOsFam.innerHTML = '';
                    var selectOption = document.createElement('option');
                    selectOption.value = 'selectMessage';
                    selectOption.innerHTML = ' -- select operating system family -- ';
                    selectOption.disabled = true;
                    selectOption.selected = true;
                    appHostOsFam.appendChild(selectOption);
                    appHostOsFam.disabled = true;
                }

                function appHostOsSelectorReset() {
                    var appHostOs = document.getElementById("appHostOsID");

                    appHostOs.innerHTML = '';
                    var selectOption = document.createElement('option');
                    selectOption.value = 'selectMessage';
                    selectOption.innerHTML = ' -- select operating system -- ';
                    selectOption.disabled = true;
                    selectOption.selected = true;
                    appHostOs.appendChild(selectOption);
                    appHostOs.disabled = true;
                }

                function databaseServerFamSelectorReset() {
                    var databaseServerFam = document.getElementById("databaseServerFamID");
 
                    databaseServerFam.innerHTML = '';
                    var selectOption = document.createElement('option');
                    selectOption.value = 'selectMessage';
                    selectOption.innerHTML = ' -- select a database server type -- ';
                    selectOption.disabled = true;
                    selectOption.selected = true;
                    databaseServerFam.appendChild(selectOption);
                }

                function databaseServerSelectorReset() {
                    var databaseServer = document.getElementById("databaseServerID");
 
                    databaseServer.innerHTML = '';
                    var selectOption = document.createElement('option');
                    selectOption.value = 'selectMessage';
                    selectOption.innerHTML = ' -- select a database server -- ';
                    selectOption.disabled = true;
                    selectOption.selected = true;
                    databaseServer.appendChild(selectOption);
                }

                function dbmsHostOsFamSelectorReset() {
                    var dbmsHostOsFam = document.getElementById("dbmsHostOsFamID");

                    dbmsHostOsFam.innerHTML = '';
                    var selectOption = document.createElement('option');
                    selectOption.value = 'selectMessage';
                    selectOption.innerHTML = ' -- select operating system family -- ';
                    selectOption.disabled = true;
                    selectOption.selected = true;
                    dbmsHostOsFam.appendChild(selectOption);
                    dbmsHostOsFam.disabled = true;
                }

                function dbmsHostOsSelectorReset() {
                    var dbmsHostOs = document.getElementById("dbmsHostOsID");

                    dbmsHostOs.innerHTML = '';
                    var selectOption = document.createElement('option');
                    selectOption.value = 'selectMessage';
                    selectOption.innerHTML = ' -- select operating system -- ';
                    selectOption.disabled = true;
                    selectOption.selected = true;
                    dbmsHostOs.appendChild(selectOption);
                    dbmsHostOs.disabled = true;
                }
                async function populateApplicationNameSelector() {
                       showSpinner() ;

                       applicationNameSelectorReset();
                       applicationVersionReset();

                       var query =     
                           "prefix oplsof: <http://www.openlinksw.com/ontology/software#> \n"
                           + "prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> \n"
                           + "select distinct \n"
                           + "  ?applicationProgram \n"
                           + "  ?applicationProgramLabel \n"
                           + "where { \n"
                           + " ?applicationProgram a oplsof:ApplicationProgram . \n"
                           + " ?applicationProgram rdfs:label ?applicationProgramLabel . \n"
                           + "}" ;

                       let url = endpoint + encodeURIComponent(query) + "&should-sponge=&format=application%2Fsparql-results%2Bjson" ;
                       const options = {
                                    method: 'GET',
                                    headers: {
                                               'Content-type': 'application/sparql-results+json; charset=UTF-8',
                                                                                 },
                                    credentials: 'include',
                                    mode: 'cors',
                                    crossDomain: true,
                                };
                        try {
                        var resp = await fetch(url, options)
                        
                                .then((res) => res.json())
                        .then( data =>{
                            if (data.results.bindings.length > 0){
                                var applicationName = document.getElementById("applicationNameID");
                                var applications = data.results.bindings;
                                for (i in applications) {
                                    var opt = document.createElement('option');
                                    opt.value = applications[i].applicationProgram.value;
                                    opt.innerHTML = applications[i].applicationProgramLabel.value;
                                    applicationName.appendChild(opt);
                                }
                                var otherOpt = document.createElement('option');
                                    otherOpt.value = "otherOption";
                                    otherOpt.innerHTML = "Other";
                                    applicationName.appendChild(otherOpt);
                                applicationName.style.display = '';
                                applicationName.disabled = false;
                                hideSpinner() ;
                            }
                            else {
                                hideSpinner() ;
                                throw new Error("No applications found");
                                console.log("No applications found");
                            }
                                })
                       } catch(e) {
                                hideSpinner() ;
                                console.error('Query Failed getting applications ', e) ;
                                errorMessage('applicationNameErrorID', 'Query Failed getting applications ' + e)
                        }                  

                }

                async function populateDatabaseServerSelector() {
                       showSpinner() ;

                       databaseServerFamSelectorReset();
                       databaseServerSelectorReset();
                       dbmsVersionReset();

                       var query =     
                           "prefix oplsof: <http://www.openlinksw.com/ontology/software#> \n"
                           + "prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> \n"
                           + "select distinct \n"
                           + "  ?databaseServer \n"
                           + "  xsd:string(?name) as ?databaseServerLabel \n"
                           + "where { \n"
                           + " ?databaseServer a oplsof:DbmsFamily . \n"
                           + " ?databaseServer <http://schema.org/name> ?name . \n" 
                           + " ?installer a <http://www.openlinksw.com/ontology/installers#InstallerArchive> . \n" 
                           + " ?installer <http://www.openlinksw.com/ontology/installers#hasInstallerArchiveCategory> <http://data.openlinksw.com/oplweb/component_category/MTServerDBInstaller#this> . \n"
                           + " ?installer <http://www.openlinksw.com/ontology/software#hasDatabaseFamily> ?databaseServer . \n"
                           + "} order by ?databaseServerLabel" ;
                       //var endpoint = "https://www.openlinksw.com/sparql?default-graph-uri=&query=" ;
                       let url = endpoint + encodeURIComponent(query) + "&should-sponge=&format=application%2Fsparql-results%2Bjson" ;
                       const options = {
                                    method: 'GET',
                                    headers: {
                                               'Content-type': 'application/sparql-results+json; charset=UTF-8',
                                                                                 },
                                    credentials: 'include',
                                    mode: 'cors',
                                    crossDomain: true,
                                };
                        try {
                        var resp = await fetch(url, options)
                        
                                .then((res) => res.json())
                        .then( data =>{
                            if (data.results.bindings.length > 0){
                                var databaseServerFam = document.getElementById("databaseServerFamID");
                                var results = data.results.bindings;
                                for (i in results) {
                                    var opt = document.createElement('option');
                                    opt.value = results[i].databaseServer.value;
                                    opt.innerHTML = results[i].databaseServerLabel.value;
                                    databaseServerFam.appendChild(opt);
                                }
                                databaseServerFam.style.display = '';
                                databaseServerFam.disabled = false;
                                hideSpinner() ;
                            }
                            else {
                                hideSpinner() ;
                                throw new Error("No database servers found");
                                console.log("No database servers found");
                            }
                                })
                       } catch(e) {
                                hideSpinner() ;
                                console.error('Query Failed getting database servers ', e) ;
                                errorMessage('databaseServerFamErrorID', 'Query Failed getting database servers ' + e);
                        }                  

                }

                async function populateAppHostOsFamSelector() {
                       showSpinner() ;

                       appHostOsFamSelectorReset();
                       appHostOsVersionReset();

                       var query =     
                           "prefix oplsof: <http://www.openlinksw.com/ontology/software#> \n"
                           + "prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> \n"
                           + "select distinct \n"
                           + "  ?opsysFamily \n"
                           + "   xsd:string(?name) as ?opsysFamilyLabel \n"
                           + "where { \n"
                           + " ?opsysFamily a oplsof:OpsysFamily . \n"
                           + " ?opsysFamily rdfs:label ?name . \n" 
                           + " ?opsysFamily oplsof:hasOperatingSystem ?os . \n" 
                           + " ?installer a <http://www.openlinksw.com/ontology/installers#InstallerArchive> . \n" 
                           + " ?installer <http://www.openlinksw.com/ontology/installers#hasInstallerArchiveCategory> <http://data.openlinksw.com/oplweb/component_category/MTServerDBInstaller#this> .\n"
                           + " ?installer <http://www.openlinksw.com/ontology/software#hasOperatingSystemFamily> ?opsysFamily . \n"
                           + "} order by ?opsysFamilyLabel" ;
                       //var endpoint = "https://www.openlinksw.com/sparql?default-graph-uri=&query=" ;
                       let url = endpoint + encodeURIComponent(query) + "&should-sponge=&format=application%2Fsparql-results%2Bjson" ;
                       const options = {
                                    method: 'GET',
                                    headers: {
                                               'Content-type': 'application/sparql-results+json; charset=UTF-8',
                                                                                 },
                                    credentials: 'include',
                                    mode: 'cors',
                                    crossDomain: true,
                                };
                        try {
                        var resp = await fetch(url, options)
                        
                                .then((res) => res.json())
                        .then( data =>{
                            if (data.results.bindings.length > 0){
                                var opsysFamily = document.getElementById("appHostOsFamID");
                                var results = data.results.bindings;
                                for (i in results) {
                                    var opt = document.createElement('option');
                                    opt.value = results[i].opsysFamily.value;
                                    opt.innerHTML = results[i].opsysFamilyLabel.value;
                                    opsysFamily.appendChild(opt);
                                }
                                opsysFamily.style.display = '';
                                opsysFamily.disabled = false;
                                hideSpinner() ;
                            }
                            else {
                                hideSpinner() ;
                                throw new Error("No operating system families found");
                                console.log("No operating system families found");
                            }
                                })
                       } catch(e) {
                                hideSpinner() ;
                                console.error('Query Failed getting operating system families ', e) ;
                                errorMessage('appHostOsFamErrorID', 'Query Failed getting operating system families ' + e);
                        }                  

                }

                async function populateDbmsHostOsFamSelector() {
                       showSpinner() ;

                       dbmsHostOsFamSelectorReset();
                       dbmsHostOsVersionReset();

                       var query =     
                           "prefix oplsof: <http://www.openlinksw.com/ontology/software#> \n"
                           + "prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> \n"
                           + "select distinct \n"
                           + "  ?opsysFamily \n"
                           + "   xsd:string(?name) as ?opsysFamilyLabel \n"
                           + "where { \n"
                           + " ?opsysFamily a oplsof:OpsysFamily . \n"
                           + " ?opsysFamily rdfs:label ?name . \n" 
                           + " ?opsysFamily oplsof:hasOperatingSystem ?os . \n" 
                           + " ?installer a <http://www.openlinksw.com/ontology/installers#InstallerArchive> . \n" 
                           + " ?installer <http://www.openlinksw.com/ontology/software#hasOperatingSystemFamily> ?opsysFamily . \n"
                           + "} order by ?opsysFamilyLabel" ;
                       //var endpoint = "https://www.openlinksw.com/sparql?default-graph-uri=&query=" ;
                       let url = endpoint + encodeURIComponent(query) + "&should-sponge=&format=application%2Fsparql-results%2Bjson" ;
                       const options = {
                                    method: 'GET',
                                    headers: {
                                               'Content-type': 'application/sparql-results+json; charset=UTF-8',
                                                                                 },
                                    credentials: 'include',
                                    mode: 'cors',
                                    crossDomain: true,
                                };
                        try {
                        var resp = await fetch(url, options)
                        
                                .then((res) => res.json())
                        .then( data =>{
                            if (data.results.bindings.length > 0){
                                var opsysFamily = document.getElementById("dbmsHostOsFamID");
                                var results = data.results.bindings;
                                for (i in results) {
                                    var opt = document.createElement('option');
                                    opt.value = results[i].opsysFamily.value;
                                    opt.innerHTML = results[i].opsysFamilyLabel.value;
                                    opsysFamily.appendChild(opt);
                                }
                                opsysFamily.style.display = '';
                                opsysFamily.disabled = false;
                                hideSpinner() ;
                            }
                            else {
                                hideSpinner() ;
                                throw new Error("No operating system families found");
                                console.log("No operating system families found");
                            }
                                })
                       } catch(e) {
                                hideSpinner() ;
                                console.error('Query Failed getting operating system families ', e) ;
                                errorMessage('dbmsHostOsFamErrorID', 'Query Failed getting operating system families ' + e);
                        }                  

                }

                async function dbmsHostOsFamSelected(opsysFamily) {
                       showSpinner() ;

                       dbmsHostOsSelectorReset();
                       resultAreaReset();
                       dbmsHostOsVersionReset();

                       var query =     
                           "DEFINE input:same-as \"yes\" \n"
                           + "prefix oplsof: <http://www.openlinksw.com/ontology/software#> \n"
                           + "select distinct \n"
                           + "  ?opSystem \n"
                           + "  xsd:string(?name) as ?opSystemLabel \n"
                           + " where { \n"
                           + " ?opSystem a oplsof:OperatingSystem . \n"
                           + " ?opSystem oplsof:OperatingSystemCommercialName ?name . \n"
                           + " ?opsysFamily oplsof:hasOperatingSystem ?opSystem .  \n"
                           + " filter (?opsysFamily = <" + opsysFamily.value + ">) . \n"
                           + " ?installer a <http://www.openlinksw.com/ontology/installers#InstallerArchive> . \n" 
                           + " ?installer <http://www.openlinksw.com/ontology/software#hasOperatingSystem> ?opSystem . \n"
                           + "} order by ?opSystem ";
                       //var endpoint = "https://www.openlinksw.com/sparql?default-graph-uri=&query=" ;
                       let url = endpoint + encodeURIComponent(query) + "&should-sponge=&format=application%2Fsparql-results%2Bjson" ;
                       const options = {
                                    method: 'GET',
                                    headers: {
                                               'Content-type': 'application/sparql-results+json; charset=UTF-8',
                                                                                 },
                                    credentials: 'include',
                                    mode: 'cors',
                                    crossDomain: true,
                                };
                        try {
                        var resp = await fetch(url, options)
                        
                                .then((res) => res.json())
                        .then( data =>{
                            if (data.results.bindings.length > 0){
                                var dbmsHostOs = document.getElementById("dbmsHostOsID");
                                var results = data.results.bindings;
                                for (i in results) {
                                    var opt = document.createElement('option');
                                    opt.value = results[i].opSystem.value;
                                    if (results[i].opSystemLabel)
                                      opt.innerHTML = results[i].opSystemLabel.value;
                                    else 
                                      opt.innerHTML = results[i].opSystem.value;
                                    dbmsHostOs.appendChild(opt);
                                }
                                dbmsHostOs.style.display = '';
                                dbmsHostOs.disabled = false;
                                hideSpinner() ;
                            }
                            else {
                                hideSpinner() ;
                                throw new Error("No operating systems found");
                                console.log("No operating systems found");
                            }
                                })
                        } catch(e) {
                                hideSpinner() ;
                                console.error('Query Failed getting operating system families ', e) ;
                                errorMessage('dbmsHostOsErrorID', 'Query Failed getting operating system families ' + e);
                        }                  
                       document.getElementById("dbmsHostOsID").focus()
                }


                async function appHostOsFamSelected(opsysFamily) {
                       showSpinner() ;

                       appHostOsSelectorReset();
                       resultAreaReset();
                       appHostOsVersionReset();

                       var query =     
                           "DEFINE input:same-as \"yes\" \n"
                           + "prefix oplsof: <http://www.openlinksw.com/ontology/software#> \n"
                           + "select distinct \n"
                           + "  ?opSystem \n"
                           + "  xsd:string(?name) as ?opSystemLabel \n"
                           + " where { \n"
                           + " ?opSystem a oplsof:OperatingSystem . \n"
                           + " ?opSystem oplsof:OperatingSystemCommercialName ?name . \n"
                           + " ?opsysFamily oplsof:hasOperatingSystem ?opSystem .  \n"
                           + " filter (?opsysFamily = <" + opsysFamily.value + ">) . \n"
                           + " ?installer a <http://www.openlinksw.com/ontology/installers#InstallerArchive> . \n" 
                           + " ?installer <http://www.openlinksw.com/ontology/installers#hasInstallerArchiveCategory> <http://data.openlinksw.com/oplweb/component_category/MTGenericClientInstaller#this> . \n"
                           + " ?installer <http://www.openlinksw.com/ontology/software#hasOperatingSystem> ?opSystem . \n"
                           + "} order by ?opSystem ";
                       //var endpoint = "https://www.openlinksw.com/sparql?default-graph-uri=&query=" ;
                       //var endpoint = "https://localhost/sparql?default-graph-uri=&query=" ;
                       let url = endpoint + encodeURIComponent(query) + "&should-sponge=&format=application%2Fsparql-results%2Bjson" ;
                       const options = {
                                    method: 'GET',
                                    headers: {
                                               'Content-type': 'application/sparql-results+json; charset=UTF-8',
                                                                                 },
                                    credentials: 'include',
                                    mode: 'cors',
                                    crossDomain: true,
                                };
                        try {
                        var resp = await fetch(url, options)
                        
                                .then((res) => res.json())
                        .then( data =>{
                            if (data.results.bindings.length > 0){
                                var appHostOs = document.getElementById("appHostOsID");
                                var results = data.results.bindings;
                                for (i in results) {
                                    var opt = document.createElement('option');
                                    opt.value = results[i].opSystem.value;
                                    if (results[i].opSystemLabel)
                                      opt.innerHTML = results[i].opSystemLabel.value;
                                    else 
                                      opt.innerHTML = results[i].opSystem.value;
                                    appHostOs.appendChild(opt);
                                }
                                appHostOs.style.display = '';
                                appHostOs.disabled = false;
                                hideSpinner() ;
                            }
                            else {
                                hideSpinner() ;
                                throw new Error("No operating systems found");
                                console.log("No operating systems found");
                            }
                                })
                        } catch(e) {
                                hideSpinner() ;
                                console.error('Query Failed getting operating system families ', e) ;
                                errorMessage('appHostOsErrorID', 'Query Failed getting operating system families ' + e);
                        }                  
                       document.getElementById("appHostOsID").focus()
                }

                async function databaseServerFamSelected(databaseServerFam) {
                       showSpinner() ;

                       databaseServerSelectorReset();
                       resultAreaReset();
                       dbmsVersionReset();

                       var query =     
                           "prefix oplsof: <http://www.openlinksw.com/ontology/software#> \n"
                           + "select distinct \n"
                           + "  ?databaseServer \n"
                           + "  xsd:string(?name) as ?databaseServerLabel \n"
                           + "where { \n"
                           + " ?databaseServer a oplsof:DbmsEngine . \n"
                           + " ?databaseServer <http://schema.org/name> ?name . \n" 
                           + " ?databaseServer oplsof:hasDatabaseFamily ?databaseServerFamily . \n"
                           + " filter (?databaseServerFamily = <" + databaseServerFam.value + ">) . \n"
                           + " ?installer a <http://www.openlinksw.com/ontology/installers#InstallerArchive> . \n" 
                           + " ?installer <http://www.openlinksw.com/ontology/software#hasDatabaseEngine> ?databaseServer . \n"
                           + "} order by ?databaseServerLabel" ;
                       //var endpoint = "https://www.openlinksw.com/sparql?default-graph-uri=&query=" ;
                       let url = endpoint + encodeURIComponent(query) + "&should-sponge=&format=application%2Fsparql-results%2Bjson" ;
                       const options = {
                                    method: 'GET',
                                    headers: {
                                               'Content-type': 'application/sparql-results+json; charset=UTF-8',
                                                                                 },
                                    credentials: 'include',
                                    mode: 'cors',
                                    crossDomain: true,
                                };
                        try {
                        var resp = await fetch(url, options)
                        
                                .then((res) => res.json())
                        .then( data =>{
                            if (data.results.bindings.length > 0){
                                var databaseServer = document.getElementById("databaseServerID");
                                var results = data.results.bindings;
                                for (i in results) {
                                    var opt = document.createElement('option');
                                    opt.value = results[i].databaseServer.value;
                                    opt.innerHTML = results[i].databaseServerLabel.value;
                                    databaseServer.appendChild(opt);
                                }
                                databaseServer.style.display = '';
                                databaseServer.disabled = false;
                                hideSpinner() ;
                            }
                            else {
                                hideSpinner() ;
                                throw new Error("No database engines found");
                                console.log("No database engines found");
                            }
                                })
                       } catch(e) {
                                hideSpinner() ;
                                console.error('Query Failed getting database engines ', e) ;
                                errorMessage('databaseServerErrorID', 'Query Failed getting database engines ' + e);
                        }                  
                       document.getElementById("databaseServerID").focus()
                }

                async function handlePermalink() {
                  var applicationName = document.getElementById("applicationNameID");
                  var appHostOsFam = document.getElementById("appHostOsFamID");
                  var appHostOs = document.getElementById("appHostOsID");
                  var databaseServerFam = document.getElementById("databaseServerFamID");
                  var databaseServer = document.getElementById("databaseServerID");
                  var dbmsHostOsFam = document.getElementById("dbmsHostOsFamID");
                  var dbmsHostOs = document.getElementById("dbmsHostOsID");

                  document.getElementById("messageSpanID").textContent = "";
                  resultAreaReset();
                  applicationNameSelectorReset();
                  appHostOsFamSelectorReset();
                  appHostOsSelectorReset();
                  databaseServerFamSelectorReset();
                  databaseServerSelectorReset();
                  dbmsHostOsFamSelectorReset();
                  dbmsHostOsSelectorReset();
                  applicationVersionReset();
                  appHostOsVersionReset();
                  dbmsVersionReset();
                  dbmsHostOsVersionReset();
                  await populateApplicationNameSelector();
                  await populateAppHostOsFamSelector();
                  await populateDatabaseServerSelector();
                  await populateDbmsHostOsFamSelector();

                  if (initialApplicationName != "") {
                    applicationName.value = initialApplicationName;
                    initialApplicationName = "";
                  }

                  if (initialAppHostOsFam != "") {
                    appHostOsFam.value = initialAppHostOsFam;
                    initialAppHostOsFam = "";
                    await appHostOsFamSelected(appHostOsFam);
                  }

                  if (initialAppHostOs != "") {
                    appHostOs.value = initialAppHostOs;
                    initialAppHostOs = "";
                  }

                  if (initialDatabaseServerFam != "") {
                    databaseServerFam.value = initialDatabaseServerFam;
                    initialDatabaseServerFam = "";
                    await databaseServerFamSelected(databaseServerFam);
                  }

                  if (initialDatabaseServer != "") {
                    databaseServer.value = initialDatabaseServer;
                    initialDatabaseServer = "";
                  }

                  if (initialDbmsHostOsFam != "") {
                    dbmsHostOsFam.value = initialDbmsHostOsFam;
                    initialDbmsHostOsFam = "";
                    await dbmsHostOsFamSelected(dbmsHostOsFam);
                  }

                  if (initialDbmsHostOs != "") {
                    dbmsHostOs.value = initialDbmsHostOs;
                    initialDbmsHostOs = "";
                  }

                  if (initialSaveLocation != "" && initialSaveLocation != "null") {
                    saveLocation = initialSaveLocation;
                    buttons = document.getElementsByName('changeUploadLocationButtonName');
                    for (var i = 0; i < buttons.length; i++) 
                        buttons[i].title = 'Current upload location: ' + saveLocation;
                    initialSaveLocatoin = "";
                  }
                  checkAllSelected();
                  findDownloads();
                }


                async function initializeApplicationNameSelector() {
                  var applicationName = document.getElementById("applicationNameID");
                  if (initialApplicationName != "") {
                    applicationName.value = initialApplicationName;
                    initialApplicationName = "";
                  }
                }

                async function initializeAppHostOsFamSelector() {
                  var opsysFamily = document.getElementById("appHostOsFamID");
                  if (initialAppHostOsFam != "") {
                    opsysFamily.value = initialAppHostOsFam;
                    initialAppHostOsFam = "";
                  }
                }

                async function initializeDatabaseServerSelector() {
                  var databaseServerFam = document.getElementById("databaseServerFamID");
                  if (initialDatabaseServerFam != "") {
                    databaseServerFam.value = initialDatabaseServerFam;
                    initialDatabaseServerFam = "";
                  }
                }

                async function initializeDbmsHostOsFamSelector() {
                  var opsysFamily = document.getElementById("dbmsHostOsFamID");
                  if (initialDbmsHostOsFam != "") {
                    opsysFamily.value = initialDbmsHostOsFam;
                    initialDbmsHostOsFam = "";
                  }
                }

                async function appNameSelected(appName) {
                  resultAreaReset();
                  checkAllSelected();
                  document.getElementById("applicationVersionID").focus()
                }

                async function applicationVersionChanged(appVersion) {
                  resultAreaReset();
                  checkAllSelected();
                  document.getElementById("appHostOsFamID").focus()
                }

                async function appHostOsSelected(appHostOs) {
                  resultAreaReset();
                  checkAllSelected();
                  document.getElementById("appHostOsVersionID").focus()
                }

                async function appHostOsVersionChanged(appHostOsVersion) {
                  resultAreaReset();
                  checkAllSelected();
                  document.getElementById("databaseServerFamID").focus()
                }

                async function databaseServerSelected(databaseServer) {
                  resultAreaReset();
                  checkAllSelected();
                  document.getElementById("dbmsVersionID").focus()
                }

                async function dbmsVersionChanged(dbmsVersion) {
                  resultAreaReset();
                  checkAllSelected();
                  document.getElementById("dbmsHostOsFamID").focus()
                }

                async function dbmsHostOsSelected(dbmsHostOs) {
                  resultAreaReset();
                  checkAllSelected();
                  document.getElementById("dbmsHostOsVersionID").focus()
                }

                async function dbmsHostOsVersionChanged(dbmsHostOsVersion) {
                  resultAreaReset();
                  checkAllSelected();
                  document.getElementById("downloadBtnID").focus()
                }

                function checkAllSelected() {
                  applicationName =  document.getElementById("applicationNameID");
                  appHostOsFam =  document.getElementById("appHostOsFamID");
                  appHostOs =  document.getElementById("appHostOsID");
                  databaseServerFam =  document.getElementById("databaseServerFamID");
                  databaseServer =  document.getElementById("databaseServerID");
                  dbmsHostOsFam =  document.getElementById("dbmsHostOsFamID");
                  dbmsHostOs =  document.getElementById("dbmsHostOsID");

                  if (applicationName.value == 'selectMessage' ||
                      appHostOsFam.value == 'selectMessage' ||
                      appHostOs.value == 'selectMessage' ||
                      databaseServerFam.value == 'selectMessage' ||
                      databaseServer.value == 'selectMessage' ||
                      dbmsHostOsFam.value == 'selectMessage' ||
                      dbmsHostOs.value == 'selectMessage') {
                    //return;
                    document.getElementById("downloadBtnID").disabled = true;
                    resetPermalink();
                  } else {
                    //findDownloads();
                    document.getElementById("downloadBtnID").disabled = false;
                  }
                }

                async function findDownloads() {
                       showSpinner() ;
                       updatePermalink();
		       errorMessagesClearAll();
                       installerArray = [];
                       document.getElementById("dataIslandID").text = JSON.stringify(getSchemaAboutRelations()); 

                       resultAreaReset();
                       // Cannot work out how to make the login work 
                       //var resp = await recordSearch();

                       //if (resp > 0) {
                         createMTHeading();
                         getMTAgentInstallers();
                         getMTClientInstallers();
                         getMTBrokerInstallers();
                         getLiteInstallers();
                       //}
                }

                async function recordSearch() {

                       applicationName = document.getElementById("applicationNameID");
                       applicationVersion = document.getElementById("applicationVersionID");
                       appHostOs = document.getElementById("appHostOsID");
                       appHostOsVersion = document.getElementById("appHostOsVersionID");
                       databaseServer = document.getElementById("databaseServerID");
                       dbmsVersion = document.getElementById("dbmsVersionID");
                       dbmsHostOs = document.getElementById("dbmsHostOsID");
                       dbmsHostOsVersion = document.getElementById("dbmsHostOsVersionID");
                       
                       var searchURI = window.location.origin + '/search/' + Date.now();
 
                       var applicationRecord =  "";
                       if (applicationName != "otherOption")
                         applicationRecord = "ecrm:hasApplication <" + applicationName.value + "> ; \n"
                       
                       var insert_cmd = 
                         "PREFIX schema: <http://schema.org/>\n" 
                         + "PREFIX ecrm: <http://www.openlinksw.com/ontology/ecrm#>\n" 
                         + "INSERT INTO GRAPH <" + graph + "> \n{\n" 
                         + "<" + searchURI + "> a ecrm:DownloadSearch ; \n"
                         + "ecrm:hasDatabaseEngine <" + databaseServer.value + "> ; \n"
                         + "ecrm:hasDbmsVersion \"" + dbmsVersion.value + "\" ; \n"
                         + applicationRecord
                         + "ecrm:hasApplicationVersion \"" + applicationVersion.value + "\" ; \n"
                         + "ecrm:hasServer <" + dbmsHostOs.value + "> ; \n"
                         + "ecrm:hasServerVersion \"" + dbmsHostOsVersion.value + "\" ; \n"
                         + "ecrm:hasClient <" + appHostOs.value + "> ; \n"
                         + "ecrm:hasClientVersion \"" + appHostOsVersion.value + "\" ; \n"
                         + "ecrm:hasTimestamp `bif:curutcdatetime()` . \n"
                         + "}";
                        
                       //var endpoint = document.getElementById("endpointID").value ;
                       //var sparul_endpoint = "https://www.openlinksw.com/sparql?default-graph-uri=&query=" ;
                       //var sparul_endpoint = "https://localhost/sparql" ;
                       var sparul_endpoint = "https://ods-qa.openlinksw.com/sparql" ;

                       let url = sparul_endpoint;
                        
                       if (document.getElementById("cmdID").checked == true) {
                        console.log("endpoint for Target SPARUL Service: " + endpoint);
                        console.log(insert_cmd);        
                       }
                        
                       const options = {
                                    method: 'POST',
                                    headers: {
                                               'Content-type': 'application/sparql-update; charset=UTF-8',
                                                                                 },
                                    credentials: 'include',
                                    mode: 'cors',
                                    crossDomain: true,
                                    body: insert_cmd,
                       };
                
                       try {
                       var resp = await solid.auth.fetch(url,options);
                                if (resp.status >= 200 && resp.status <= 300) {
                                        console.log(resp.status + " - " + resp.statusText) ;
                                        hideSpinner() ;
                                        return resp.status;
                                } else {
                                        if (resp.status = 403) { 
                                          // throw new Error("You must log in to continue") ;
                                          hideSpinner() ;
                                          await authLogin(true);
                                          var secondAttempt = await recordSearch();
                                          return secondAttempt;
                                        }
                                        else 
                                          throw new Error("'Insert Failed: Error " + resp.status +" - " + resp.statusText) ;
                                }

                       } catch(e) {
                                hideSpinner() ;
                                console.error('Insert Failed', e) ;
                                return 0;
                       }  

 
                }

                function createMTHeading() {
                                var resultAreaMultitier = document.getElementById("resultAreaMultitierID");
                                var heading = document.createElement('h2');
                                heading.innerHTML = "Enterprise Edition Installers"; 
                                resultAreaMultitier.appendChild(heading);
                }

                async function getMTAgentInstallers() {
                       var localInstallerArray = [];

                       databaseServerFam = document.getElementById("databaseServerFamID");
                       databaseServer = document.getElementById("databaseServerID");
                       appHostOs = document.getElementById("appHostOsID");
                       dbmsHostOs = document.getElementById("dbmsHostOsID");

                       if (saveLocation == '') saveLocation = solid_storage;

                       var query =     
                           "DEFINE input:same-as \"yes\" \n"
                           + "select distinct ?installer ?version ?title ?url \n"
                           + "where { \n"
                           + "?installer a <http://www.openlinksw.com/ontology/installers#InstallerArchive> . \n"
                           + "?installer <http://schema.org/name> ?title . \n"
                           + "?installer <http://schema.org/downloadUrl> ?url . \n"
                           + "?installer <http://www.openlinksw.com/ontology/software#hasDatabaseEngine> <" + databaseServer.value + "> . \n"
                           + "?installer <http://www.openlinksw.com/ontology/software#hasOperatingSystem> <" + dbmsHostOs.value + "> . \n"
                           + "?installer <http://www.openlinksw.com/ontology/installers#hasInstallerArchiveCategory> <http://data.openlinksw.com/oplweb/component_category/MTServerDBInstaller#this> . \n"
                           + "?installer <http://www.openlinksw.com/ontology/products#versionText> ?version . \n"
                           + "} order by ?version ";
                       //var endpoint = "https://www.openlinksw.com/sparql?default-graph-uri=&query=" ;
                       let url = endpoint + encodeURIComponent(query) + "&should-sponge=&format=application%2Fsparql-results%2Bjson" ;

                       const options = {
                                    method: 'GET',
                                    headers: {
                                               'Content-type': 'application/sparql-results+json; charset=UTF-8',
                                                                                 },
                                    credentials: 'include',
                                    mode: 'cors',
                                    crossDomain: true,
                                };
                        try {
                        var resp = await fetch(url, options)
                                .then((res) => res.json())
                        .then( data =>{
                            if (data.results.bindings.length > 0){
                                var resultArea = document.getElementById("resultAreaMultitierID");
                                var results = data.results.bindings;
                                var heading = document.createElement('h3');
                                var messageArea = document.createElement('p');
                                var changeUploadLocationButton = document.createElement('button');
                                changeUploadLocationButton.name = 'changeUploadLocationButtonName';
                                changeUploadLocationButton.setAttribute('data-toggle', 'modal');
                                changeUploadLocationButton.setAttribute('data-target', '#modalID');
                                changeUploadLocationButton.classList.add("btn");
                                changeUploadLocationButton.classList.add("btn-primary");
                                if (saveLocation != null)
                                  changeUploadLocationButton.title = 'Current upload location: ' + saveLocation;
                                else
                                  changeUploadLocationButton.title = 'No upload location set';
                                changeUploadLocationButton.innerHTML = 'Change upload location';
                                changeUploadLocationButton.style = 'margin: 10px; float: right';
                                document.getElementById('uploadLocationID').value = saveLocation;
                                heading.innerHTML = "Database Agent Component Installers"; 
                                messageArea.classList.add("errorMessage"); 
                                messageArea.id = 'agentResultsErrorID';
                                var table = document.createElement('table');
                                table.classList.add ("table"); 
                                table.classList.add ("table-bordered"); 
                                var tableBody = document.createElement('tbody');
                                table.appendChild(tableBody);
                                for (i in results) {
                                    var tableRow = document.createElement('tr');
                                    var tableData1 = document.createElement('td');
                                    tableData1.innerHTML = "Release " + results[i].version.value;
                                    tableRow.appendChild(tableData1);
                                    var tableData2 = document.createElement('td');
                                    var link = document.createElement('a');
                                    link.innerHTML = results[i].title.value;
                                    link.href = results[i].installer.value;
                                    tableData2.appendChild(link);
                                    tableRow.appendChild(tableData2);
                                    var tableData3 = document.createElement('td');
                                    var downloadLink = document.createElement('a');
                                    downloadLink.href = results[i].url.value;
                                    var downloadButton = document.createElement('button');
                                    downloadButton.classList.add("btn");
                                    downloadButton.classList.add("btn-primary");
                                    downloadButton.innerHTML = "Download";
                                    downloadButton.title = results[i].url.value;
                                    downloadLink.appendChild(downloadButton);
                                    tableData3.appendChild(downloadLink);
                                    tableRow.appendChild(tableData3);
                                    var tableData4 = document.createElement('td');
                                    var uploadButton = document.createElement('button');
                                    uploadButton.innerHTML = "Upload";
                                    uploadButton.classList.add("btn");
                                    uploadButton.classList.add("btn-primary");
                                    uploadButton.onclick = function() {uploadFile(this, 'agentResultsErrorID')}
                                    uploadButton.value = results[i].url.value;
                                    uploadButton.title = results[i].url.value;
                                    tableData4.appendChild(uploadButton);
                                    tableRow.appendChild(tableData4);
                                    tableBody.appendChild(tableRow);
                                    localInstallerArray = localInstallerArray.concat(results[i].installer.value);
                                }
                                resultArea.appendChild(heading);
                                resultArea.appendChild(messageArea);
                                resultArea.appendChild(changeUploadLocationButton);
                                resultArea.appendChild(table)
                                installerArray = installerArray.concat(localInstallerArray);
                                document.getElementById("dataIslandID").text = JSON.stringify(getSchemaAboutRelations()); 
                                hideSpinner() ;
                            }
                            else {
                                //throw new Error("No database agent installers found");
                                console.log("No database agent installers found");
                                var resultArea = document.getElementById("resultAreaMultitierID");
                                var heading = document.createElement('h3');
                                heading.innerHTML = "Database Agent Component Installers"; 
                                var infoMessage = document.createElement('p');
                                infoMessage.innerHTML = "No database agent installer found";
                                resultArea.appendChild(heading);
                                resultArea.appendChild(infoMessage);
                                hideSpinner() ;
                            }
                        })
                        } catch(e) {
                                console.error('Error getting multitier agent installers ', e) ;
                                errorMessage('resultAreaMultitierErrorID', 'Error getting installers ' + e);
                        }                  
                }

                async function getMTClientInstallers() {
                       var localInstallerArray = [];

                       databaseServerFam = document.getElementById("databaseServerFamID");
                       databaseServer = document.getElementById("databaseServerID");
                       appHostOs = document.getElementById("appHostOsID");
                       dbmsHostOs = document.getElementById("dbmsHostOsID");

                       if (saveLocation == '') saveLocation = solid_storage;

                       var query =     
                           "DEFINE input:same-as \"yes\" \n"
                           + "select distinct ?installer ?version ?title ?url \n"
                           + "where { \n"
                           + "?installer a <http://www.openlinksw.com/ontology/installers#InstallerArchive> . \n"
                           + "?installer <http://schema.org/name> ?title . \n"
                           + "?installer <http://schema.org/downloadUrl> ?url . \n"
                           + "?installer <http://www.openlinksw.com/ontology/software#hasOperatingSystem> <" + appHostOs.value + "> . \n"
                           + "?installer <http://www.openlinksw.com/ontology/installers#hasInstallerArchiveCategory> <http://data.openlinksw.com/oplweb/component_category/MTGenericClientInstaller#this> . \n"
                           + "?installer <http://www.openlinksw.com/ontology/products#versionText> ?version . \n"
                           + "} order by ?version ";
                       //var endpoint = "https://www.openlinksw.com/sparql?default-graph-uri=&query=" ;
                       let url = endpoint + encodeURIComponent(query) + "&should-sponge=&format=application%2Fsparql-results%2Bjson" ;

                       const options = {
                                    method: 'GET',
                                    headers: {
                                               'Content-type': 'application/sparql-results+json; charset=UTF-8',
                                                                                 },
                                    credentials: 'include',
                                    mode: 'cors',
                                    crossDomain: true,
                                };
                        try {
                        var resp = await fetch(url, options)
                                .then((res) => res.json())
                        .then( data =>{
                            if (data.results.bindings.length > 0){
                                var resultArea = document.getElementById("resultAreaMultitierID");
                                var results = data.results.bindings;
                                var heading = document.createElement('h3');
                                var messageArea = document.createElement('p');
                                var changeUploadLocationButton = document.createElement('button');
                                changeUploadLocationButton.name = 'changeUploadLocationButtonName';
                                changeUploadLocationButton.setAttribute('data-toggle', 'modal');
                                changeUploadLocationButton.setAttribute('data-target', '#modalID');
                                changeUploadLocationButton.classList.add("btn");
                                changeUploadLocationButton.classList.add("btn-primary");
                                if (saveLocation != null)
                                  changeUploadLocationButton.title = 'Current upload location: ' + saveLocation;
                                else
                                  changeUploadLocationButton.title = 'No upload location set';
                                changeUploadLocationButton.innerHTML = 'Change upload location';
                                changeUploadLocationButton.style = 'margin: 10px; float: right';
                                document.getElementById('uploadLocationID').value = saveLocation;
                                heading.innerHTML = "Generic Client Component Installers"; 
                                messageArea.classList.add("errorMessage"); 
                                messageArea.id = 'clientResultsErrorID';
                                var table = document.createElement('table');
                                table.classList.add ("table"); 
                                table.classList.add ("table-bordered"); 
                                var tableBody = document.createElement('tbody');
                                table.appendChild(tableBody);
                                for (i in results) {
                                    var tableRow = document.createElement('tr');
                                    var tableData1 = document.createElement('td');
                                    tableData1.innerHTML = "Release " + results[i].version.value;
                                    tableRow.appendChild(tableData1);
                                    var tableData2 = document.createElement('td');
                                    var link = document.createElement('a');
                                    link.innerHTML = results[i].title.value;
                                    link.href = results[i].installer.value;
                                    tableData2.appendChild(link);
                                    tableRow.appendChild(tableData2);
                                    var tableData3 = document.createElement('td');
                                    var downloadLink = document.createElement('a');
                                    downloadLink.href = results[i].url.value;
                                    var downloadButton = document.createElement('button');
                                    downloadButton.classList.add("btn");
                                    downloadButton.classList.add("btn-primary");
                                    downloadButton.innerHTML = "Download";
                                    downloadButton.title = results[i].url.value;
                                    downloadLink.appendChild(downloadButton);
                                    tableData3.appendChild(downloadLink);
                                    tableRow.appendChild(tableData3);
                                    var tableData4 = document.createElement('td');
                                    var uploadButton = document.createElement('button');
                                    uploadButton.innerHTML = "Upload";
                                    uploadButton.classList.add("btn");
                                    uploadButton.classList.add("btn-primary");
                                    uploadButton.onclick = function() {uploadFile(this, 'clientResultsErrorID')}
                                    uploadButton.value = results[i].url.value;
                                    uploadButton.title = results[i].url.value;
                                    tableData4.appendChild(uploadButton);
                                    tableRow.appendChild(tableData4);
                                    tableBody.appendChild(tableRow);
                                    localInstallerArray = localInstallerArray.concat(results[i].installer.value);
                                }
                                resultArea.appendChild(heading);
                                resultArea.appendChild(messageArea);
                                resultArea.appendChild(changeUploadLocationButton);
                                resultArea.appendChild(table);
                                installerArray = installerArray.concat(localInstallerArray);
                                document.getElementById("dataIslandID").text = JSON.stringify(getSchemaAboutRelations()); 
                                hideSpinner() ;
                            }
                            else {
                                //throw new Error("No generic client installers found");
                                console.log("No generic client installers found");
                                var resultArea = document.getElementById("resultAreaMultitierID");
                                var heading = document.createElement('h3');
                                heading.innerHTML = "Generic Client Component Installers"; 
                                var infoMessage = document.createElement('p');
                                infoMessage.innerHTML = "No generic client installers found";
                                resultArea.appendChild(heading);
                                resultArea.appendChild(infoMessage);
                                hideSpinner() ;
                            }
                        })
                        } catch(e) {
                                console.error('Error getting database agent installers ', e) ;
                                errorMessage('resultAreaMultitierErrorID', 'Error getting installers ' + e);
                        }                  
                }

                async function getMTBrokerInstallers() {
                       var localInstallerArray = [];

                       databaseServerFam = document.getElementById("databaseServerFamID");
                       databaseServer = document.getElementById("databaseServerID");
                       appHostOs = document.getElementById("appHostOsID");
                       dbmsHostOs = document.getElementById("dbmsHostOsID");

                       if (saveLocation == '') saveLocation = solid_storage;

                       var query =     
                           "DEFINE input:same-as \"yes\" \n"
                           + "select distinct ?installer ?version ?title ?url \n"
                           + "where { \n"
                           + "?installer a <http://www.openlinksw.com/ontology/installers#InstallerArchive> . \n"
                           + "?installer <http://schema.org/name> ?title . \n"
                           + "?installer <http://schema.org/downloadUrl> ?url . \n"
                           + "?installer <http://www.openlinksw.com/ontology/software#hasOperatingSystem> <" + dbmsHostOs.value + "> . \n"
                           + "?installer <http://www.openlinksw.com/ontology/installers#hasInstallerArchiveCategory> <http://data.openlinksw.com/oplweb/component_category/MTServerRBrokerInstaller#this> . \n"
                           + "?installer <http://www.openlinksw.com/ontology/products#versionText> ?version . \n"
                           + "} order by ?version ";
                       //var endpoint = "https://www.openlinksw.com/sparql?default-graph-uri=&query=" ;
                       let url = endpoint + encodeURIComponent(query) + "&should-sponge=&format=application%2Fsparql-results%2Bjson" ;

                       const options = {
                                    method: 'GET',
                                    headers: {
                                               'Content-type': 'application/sparql-results+json; charset=UTF-8',
                                                                                 },
                                    credentials: 'include',
                                    mode: 'cors',
                                    crossDomain: true,
                                };
                        try {
                        var resp = await fetch(url, options)
                                .then((res) => res.json())
                        .then( data =>{
                            if (data.results.bindings.length > 0){
                                var resultArea = document.getElementById("resultAreaMultitierID");
                                var results = data.results.bindings;
                                var heading = document.createElement('h3');
                                var messageArea = document.createElement('p');
                                var changeUploadLocationButton = document.createElement('button');
                                changeUploadLocationButton.name = 'changeUploadLocationButtonName';
                                changeUploadLocationButton.setAttribute('data-toggle', 'modal');
                                changeUploadLocationButton.setAttribute('data-target', '#modalID');
                                changeUploadLocationButton.classList.add("btn");
                                changeUploadLocationButton.classList.add("btn-primary");
                                if (saveLocation != null)
                                  changeUploadLocationButton.title = 'Current upload location: ' + saveLocation;
                                else
                                  changeUploadLocationButton.title = 'No upload location set';
                                changeUploadLocationButton.innerHTML = 'Change upload location';
                                changeUploadLocationButton.style = 'margin: 10px; float: right';
                                document.getElementById('uploadLocationID').value = saveLocation;
                                heading.innerHTML = "Request Broker Component Installers"; 
                                messageArea.classList.add("errorMessage"); 
                                messageArea.id = 'rqbResultsErrorID';
                                var table = document.createElement('table');
                                table.classList.add ("table"); 
                                table.classList.add ("table-bordered"); 
                                var tableBody = document.createElement('tbody');
                                table.appendChild(tableBody);
                                for (i in results) {
                                    var tableRow = document.createElement('tr');
                                    var tableData1 = document.createElement('td');
                                    tableData1.innerHTML = "Release " + results[i].version.value;
                                    tableRow.appendChild(tableData1);
                                    var tableData2 = document.createElement('td');
                                    var link = document.createElement('a');
                                    link.innerHTML = results[i].title.value;
                                    link.href = results[i].installer.value;
                                    tableData2.appendChild(link);
                                    tableRow.appendChild(tableData2);
                                    var tableData3 = document.createElement('td');
                                    var downloadLink = document.createElement('a');
                                    downloadLink.href = results[i].url.value;
                                    var downloadButton = document.createElement('button');
                                    downloadButton.classList.add("btn");
                                    downloadButton.classList.add("btn-primary");
                                    downloadButton.innerHTML = "Download";
                                    downloadButton.title = results[i].url.value;
                                    downloadLink.appendChild(downloadButton);
                                    tableData3.appendChild(downloadLink);
                                    tableRow.appendChild(tableData3);
                                    var tableData4 = document.createElement('td');
                                    var uploadButton = document.createElement('button');
                                    uploadButton.innerHTML = "Upload";
                                    uploadButton.classList.add("btn");
                                    uploadButton.classList.add("btn-primary");
                                    uploadButton.onclick = function() {uploadFile(this, 'rqbResultsErrorID')}
                                    uploadButton.value = results[i].url.value;
                                    uploadButton.title = results[i].url.value;
                                    tableData4.appendChild(uploadButton);
                                    tableRow.appendChild(tableData4);
                                    tableBody.appendChild(tableRow);
                                    localInstallerArray = localInstallerArray.concat(results[i].installer.value);
                                }
                                resultArea.appendChild(heading);
                                resultArea.appendChild(messageArea);
                                resultArea.appendChild(changeUploadLocationButton);
                                resultArea.appendChild(table);
                                installerArray = installerArray.concat(localInstallerArray);
                                document.getElementById("dataIslandID").text = JSON.stringify(getSchemaAboutRelations()); 
                                hideSpinner() ;
                            }
                            else {
                                //throw new Error("No request broker installers found");
                                console.log("No request broker installers found");
                                var resultArea = document.getElementById("resultAreaMultitierID");
                                var heading = document.createElement('h3');
                                heading.innerHTML = "Request Broker Component Installers"; 
                                var infoMessage = document.createElement('p');
                                infoMessage.innerHTML = "No request broker installers found";
                                resultArea.appendChild(heading);
                                resultArea.appendChild(infoMessage);
                                hideSpinner() ;
                            }
                        })
                        } catch(e) {
                                console.error('Error getting request broker installers ', e) ;
                                errorMessage('resultAreaMultitierErrorID', 'Error getting installers ' + e);
                        }                  
                }

                async function getLiteInstallers() {
                       var localInstallerArray = [];

                       databaseServerFam = document.getElementById("databaseServerFamID");
                       databaseServer = document.getElementById("databaseServerID");
                       appHostOs = document.getElementById("appHostOsID");
                       dbmsHostOs = document.getElementById("dbmsHostOsID");

                       if (saveLocation == '') saveLocation = solid_storage;

                       var query =     
                           "DEFINE input:same-as \"yes\" \n"
                           + "select distinct ?installer ?version ?title ?url \n"
                           + "where { \n"
                           + "?installer a <http://www.openlinksw.com/ontology/installers#InstallerArchive> . \n"
                           + "?installer <http://schema.org/name> ?title . \n"
                           + "?installer <http://schema.org/downloadUrl> ?url . \n"
                           + "?installer <http://www.openlinksw.com/ontology/software#hasDatabaseEngine> <" + databaseServer.value + "> . \n"
                           + "?installer <http://www.openlinksw.com/ontology/software#hasOperatingSystem> <" + appHostOs.value + "> . \n"
                           + "?installer <http://www.openlinksw.com/ontology/installers#hasInstallerArchiveCategory> <http://data.openlinksw.com/oplweb/component_category/STLiteInstaller#this> . \n"
                           + "?installer <http://www.openlinksw.com/ontology/products#versionText> ?version . \n"
                           + "} order by ?version ";
                       //var endpoint = "https://www.openlinksw.com/sparql?default-graph-uri=&query=" ;
                       let url = endpoint + encodeURIComponent(query) + "&should-sponge=&format=application%2Fsparql-results%2Bjson" ;

                       const options = {
                                    method: 'GET',
                                    headers: {
                                               'Content-type': 'application/sparql-results+json; charset=UTF-8',
                                                                                 },
                                    credentials: 'include',
                                    mode: 'cors',
                                    crossDomain: true,
                                };
                        try {
                        var resp = await fetch(url, options)
                                .then((res) => res.json())
                        .then( data =>{
                            if (data.results.bindings.length > 0){
                                var resultArea = document.getElementById("resultAreaLiteID");
                                var results = data.results.bindings;
                                var heading = document.createElement('h2');
                                var messageArea = document.createElement('p');
                                var changeUploadLocationButton = document.createElement('button');
                                changeUploadLocationButton.name = 'changeUploadLocationButtonName';
                                changeUploadLocationButton.setAttribute('data-toggle', 'modal');
                                changeUploadLocationButton.setAttribute('data-target', '#modalID');
                                changeUploadLocationButton.classList.add("btn");
                                changeUploadLocationButton.classList.add("btn-primary");
                                if (saveLocation != null)
                                  changeUploadLocationButton.title = 'Current upload location: ' + saveLocation;
                                else
                                  changeUploadLocationButton.title = 'No upload location set';
                                changeUploadLocationButton.innerHTML = 'Change upload location';
                                changeUploadLocationButton.style = 'margin: 10px; float: right';
                                document.getElementById('uploadLocationID').value = saveLocation;
                                heading.innerHTML = "Lite Edition Installers"; 
                                messageArea.classList.add("errorMessage"); 
                                messageArea.id = 'liteResultsErrorID';
                                var table = document.createElement('table');
                                table.classList.add ("table"); 
                                table.classList.add ("table-bordered"); 
                                var tableBody = document.createElement('tbody');
                                table.appendChild(tableBody);
                                for (i in results) {
                                    var tableRow = document.createElement('tr');
                                    var tableData1 = document.createElement('td');
                                    tableData1.innerHTML = "Release " + results[i].version.value;
                                    tableRow.appendChild(tableData1);
                                    var tableData2 = document.createElement('td');
                                    var link = document.createElement('a');
                                    link.innerHTML = results[i].title.value;
                                    link.href = results[i].installer.value;
                                    tableData2.appendChild(link);
                                    tableRow.appendChild(tableData2);
                                    var tableData3 = document.createElement('td');
                                    var downloadLink = document.createElement('a');
                                    downloadLink.href = results[i].url.value;
                                    var downloadButton = document.createElement('button');
                                    downloadButton.classList.add("btn");
                                    downloadButton.classList.add("btn-primary");
                                    downloadButton.innerHTML = "Download";
                                    downloadButton.title = results[i].url.value;
                                    downloadLink.appendChild(downloadButton);
                                    tableData3.appendChild(downloadLink);
                                    tableRow.appendChild(tableData3);
                                    var tableData4 = document.createElement('td');
                                    var uploadButton = document.createElement('button');
                                    uploadButton.innerHTML = "Upload";
                                    uploadButton.classList.add("btn");
                                    uploadButton.classList.add("btn-primary");
                                    uploadButton.onclick = function() {uploadFile(this, 'liteResultsErrorID')}
                                    uploadButton.value = results[i].url.value;
                                    uploadButton.title = results[i].url.value;
                                    tableData4.appendChild(uploadButton);
                                    tableRow.appendChild(tableData4);
                                    tableBody.appendChild(tableRow);
                                    localInstallerArray = localInstallerArray.concat(results[i].installer.value);
                                }
                                resultArea.appendChild(heading);
                                resultArea.appendChild(messageArea);
                                resultArea.appendChild(changeUploadLocationButton);
                                resultArea.appendChild(table);
                                installerArray = installerArray.concat(localInstallerArray);
                                document.getElementById("dataIslandID").text = JSON.stringify(getSchemaAboutRelations()); 
                                hideSpinner() ;
                            }
                            else {
                                //throw new Error("No lite edition installers found");
                                console.log("No lite edition installers found");
                                var resultArea = document.getElementById("resultAreaLiteID");
                                var heading = document.createElement('h2');
                                heading.innerHTML = "Lite Edition Installers"; 
                                var infoMessage = document.createElement('p');
                                infoMessage.innerHTML = "No lite edition installers found";
                                resultArea.appendChild(heading);
                                resultArea.appendChild(infoMessage);
                                hideSpinner() ;
                            }
                        })
                        } catch(e) {
                                console.error('Error getting lite edition installers ', e) ;
                                errorMessage('resultAreaLiteErrorID', 'Error getting installers ' + e);
                        }                  
                }

                function saveUploadLocation() {
		          errorMessagesClearAll();
                          saveLocation = document.getElementById('uploadLocationID').value;
                          // if there is a final / remove it...
                          if (saveLocation.endsWith ('/')) saveLocation = saveLocation.substring(0, saveLocation.length - 1);
                          buttons = document.getElementsByName('changeUploadLocationButtonName');
                          for (var i = 0; i < buttons.length; i++) 
                             buttons[i].title = 'Current upload location: ' + saveLocation;
                          updatePermalink();
                }

                function getNameFromInstallerUrl(url) {
                        if (url.indexOf("/") > 0)
                          return url.substring(url.lastIndexOf("/") + 1, url.length);
                        else 
                          return url;
                }

                async function fileExists (fileName, button, messageElementID) {
console.log('In file exists');
                        const options = {
	                                        method: 'HEAD',
	                                        credentials: 'include',
	                                        mode: 'cors',
	                                        crossDomain: true,
	                    };
	
                            try {
                            var resp = await solid.auth.fetch(saveLocation + '/' + fileName, options);
                            	if (resp.status == 401 || resp.status == 403) {
                            	        errorMessage(messageElementID, 'Access denied to the configured upload location ');
                            		hideSpinner() ;
                                        await authLogin();
                                        uploadFile(button, messageElementID);
                            	}
                            	else if (resp.status == 404) {
                            		hideSpinner() ;
                                        return false;
                            	} else {
                            		hideSpinner() ;
                                        return true; 
                            	}
                            } catch (e) {
                            	hideSpinner() ;
                            	console.error('Failed ' + e) ;
                            	errorMessage(messageElementID, 'Failed ' + e);
                            }
                }


                async function uploadFile (button, messageElementID) {

		        errorMessagesClearAll();
                        if (saveLocation == null || saveLocation == "") {
                            errorMessage(messageElementID, 'Upload Failed: No upload location set');
                            return;
                        }
                        showSpinner() ;
                        var fileName = getNameFromInstallerUrl(button.value);
                        try {
                            if (await fileExists(fileName, button, messageElementID)) {
                              hideSpinner() ;
                              if (confirm("File " + fileName  + " exists, do you want to overwrite it?") == false) 
                                return;
                            }
	                    const options = {
	                                        method: 'PUT',
	                                        headers: {
	                                                   'Content-type': 'application/octet-stream',
	                    								 },
	                                        credentials: 'include',
	                                        mode: 'cors',
	                                        crossDomain: true,
                                                body: button.value
	                    };
	
                            var resp = await solid.auth.fetch(saveLocation + '/'+ fileName, options);
                            	if (resp.status >= 200 && resp.status <= 300) {
                            		hideSpinner() ;
                            		//console.log(resp.status + " - " + resp.statusText);
                            	}
                            	else if (resp.status == 401 || resp.status == 403) {
                            		hideSpinner() ;
                                        await authLogin();
                                        // try again...
                                        var resp2 = await solid.auth.fetch(saveLocation + '/'+ fileName, options);
                            	        if (resp.status >= 200 && resp.status <= 300) {
                            		  hideSpinner() ;
                            	        } else {
                            		  hideSpinner() ;
                            		  throw new Error("Error " + resp.status +" - " + resp.statusText) ;
                            	        }
                            	}
                            	else {
                            		hideSpinner() ;
                            		throw new Error("Error " + resp.status +" - " + resp.statusText) ;
                            	}
                            } catch (e) {
                            	hideSpinner() ;
                            	console.error('Upload Failed ' + e) ;
                            	errorMessage(messageElementID, 'Upload Failed ' + e);
                            } finally {
                                window.location = document.getElementById("permalinkID").href;
                            }
                }

                function resetPermalink () {
                       permalink = document.getElementById("permalinkID");
                       permalink.href = window.location.origin + window.location.pathname;
                }

                function updatePermalink () {

                       var permalink = document.getElementById("permalinkID");
                       var applicationName = document.getElementById("applicationNameID");
                       var appHostOsFam = document.getElementById("appHostOsFamID");
                       var appHostOs = document.getElementById("appHostOsID");
                       var databaseServerFam = document.getElementById("databaseServerFamID");
                       var databaseServer = document.getElementById("databaseServerID");
                       var dbmsHostOsFam = document.getElementById("dbmsHostOsFamID");
                       var dbmsHostOs = document.getElementById("dbmsHostOsID");

                       permalink.href = window.location.origin + window.location.pathname;
                       permalink.href = permalink.href + "?getResults=true&";
                       permalink.href = permalink.href + "applicationName=" +  encodeURIComponent(applicationName.value) + "&";
                       permalink.href = permalink.href + "appHostOsFam=" +  encodeURIComponent(appHostOsFam.value) + "&";
                       permalink.href = permalink.href + "appHostOs=" +  encodeURIComponent(appHostOs.value) + "&";
                       permalink.href = permalink.href + "databaseServerFam=" +  encodeURIComponent(databaseServerFam.value) + "&";
                       permalink.href = permalink.href + "databaseServer=" +  encodeURIComponent(databaseServer.value) + "&";
                       permalink.href = permalink.href + "dbmsHostOsFam=" +  encodeURIComponent(dbmsHostOsFam.value) + "&";
                       permalink.href = permalink.href + "dbmsHostOs=" +  encodeURIComponent(dbmsHostOs.value) + "&";
                       permalink.href = permalink.href + "saveLocation=" +  encodeURIComponent(saveLocation);
                }
	</script>
	<!-- These functions are used for Authentication -->
	<script>
        async function fetchProfile(webId) {
           try {
             var rc = await loadProfile(webId);

             var uriObj = new URL(webId)
             uriObj.hash = uriObj.search = uriObj.query = '';

             var base = uriObj.toString()
             const kb = $rdf.graph()

             $rdf.parse(rc.profile, kb, base, rc.content_type);

             const LDP = $rdf.Namespace("http://www.w3.org/ns/ldp#");
             const PIM = $rdf.Namespace("http://www.w3.org/ns/pim/space#");

             const s_webId = $rdf.sym(webId)

             uriObj.pathname = '/';
             var ret = uriObj.toString();

             var store = kb.any(s_webId, PIM('storage'));
             var inbox = kb.any(s_webId, LDP('inbox'));
             if (store)
               ret = store.value;
             else if (inbox)
               ret = inbox.value;

             return ret;
           } catch(e) {
			   console.error('Error fetching profile information', e)
			   alert('Error fetching profile information', e)
			   return null;
           }
        }

        async function loadProfile(url) {
           const options = {
                             method: 'GET',
                             headers: {'Accept': 'text/turtle, application/ld+json'},
                             credentials: 'include',
                             mode: 'cors',
                             crossDomain: true,
                         };
           try {
               var resp = await solid.auth.fetch(url, options);
               if (resp.ok) {
 		  var body = await resp.text();
 		  var contentType = resp.headers.get('content-type');
 		  return {profile: body, contentType};
               } 
 	      else {
 	        console.log("Error " + resp.status +" - " + resp.statusText)
               }
           } 
 	  catch(e) {
		  console.error('loadProfile request failed', e)
		  alert('loadProfile request failed ', e)
           }
        }

        async function authLogin(refresh) {
            const popupUri = './common/popup.html'

            const session = await solid.auth.popupLogin({ popupUri })
            if (session) {
                // Make authenticated request to the server to establish a session cookie
               const {status} = await solid.auth.fetch(location, { method: 'HEAD' })

               if (status === 401) {
                   alert(`Invalid login.\n\nDid you set ${session.idp} as your OIDC provider in your profile ${session.webId}?`)
                   await solid.auth.logout()
               }
               // Now that we have a cookie, reload to display the authenticated page
               if (refresh)
                 window.location = document.getElementById("permalinkID").href;
            }
        }
       
        async function authLogout () {
            await solid.auth.logout()
            location.reload()
        }
	</script>
  </body>
</html>

